---
title: "NEH Grants Data Analysis"
author: "Brian A. Danielak"
format: 
  html:
    toc: true
editor: visual
---

# Loading and Cleaning the Data

## Loading Necessary Libraries

```{r}
# #| echo: false
# #| message: false
library(tidyverse)
library(forcats)
library(vroom)
library(xml2)
```

## Loading Grant Data from Downloaded XML

```{r}
load_grants_from_raw_xml <- function(path_to_xml) {
  
  # First, we check if the rectangularized file already exists.
  if (file.exists("data-cleaned/grants-data-cleaned.tsv")) {
    
    # If it exists, we load it and return it
    grants_cleaned <- vroom::vroom("data-cleaned/grants-data-cleaned.tsv")
    return(grants_cleaned)
  
  # Otherwise, we do the expensive thing
  } else {
      grants_raw <- xml2::read_xml(path_to_xml) |> 
        xml2::as_list()
      
      grants_tibble <- grants_raw$Grants |> 
        lapply(unlist) |> 
        dplyr::bind_rows()
  
      # Write the file out so we can load it next time
      grants_tibble |> 
        dplyr::transmute_all(unlist) |> 
        vroom::vroom_write("data-cleaned/grants-data-cleaned.tsv")
      
      # Load the file (vroom will help infer column types automatically on load)
      grants_cleaned <- vroom::vroom("data-cleaned/grants-data-cleaned.tsv") 
      return(grants_cleaned)
  }
}

# I downloaded and unzipped the 2000s grant data
grants_2000s <- load_grants_from_raw_xml("data-raw/NEH_Grants2000s_Flat/NEH_Grants2000s_Flat.xml")
```

# Inspecting the Data

First, let's get an idea of what the data looks like.

```{r}
grants_2000s |> 
  dplyr::glimpse()
```

Which programs represent the most grants awarded?

```{r}
grants_2000s |> 
  dplyr::count(Program) |> 
  arrange(desc(n))
```

What happens if we combine the Award Outright with the Award Matching to get a sense of the total distribution of award amounts?

```{r}
grants_2000s |> 
  mutate(TotalAmount = AwardOutright + AwardMatching) |> 
  ggplot() +
  geom_histogram(aes(x = TotalAmount))
  
  
```

Hmm, that's strange.
It looks like we have a skewed distribution with a long right tail.
The histogram suggests there may be just a few awards totaling \$4,000,000 or more.
Let's look at how many awards exceed \$1,000,000.

```{r}
exceed_1_million_in_funding <- grants_2000s |> 
  mutate(TotalAmount = AwardOutright + AwardMatching) |> 
  filter(TotalAmount > 1e6)

dim(exceed_1_million_in_funding)[1]
```

Looks like there are 179 projects that exceed \$1 million in funding.
What happens if we look at *their* distribution?
